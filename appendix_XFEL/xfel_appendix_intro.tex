\part{LPD-CCC Interface} % (fold)
\label{prt:lpd_ccc_interface}
\chapter{Introduction} % (fold)
\label{cha:lpd_ccc_introduction}
\section{XFEL: an overview} % (fold)
\label{sec:xfel_an_overview}
The European~XFEL (X-ray Free-Electron Laser) is a 3.4~km X-ray source under-construction below Hamburg in Germany. The project is scheduled to begin operation in 2016 with construction finishing in 2015. To produce the x-rays electrons are accelerated to 17.5~GeV then passed through an `undulator' where the electrons emit synchrotron radiation (i.e.\ x-rays). The x-rays have a wavelength of between 0.05~nm and 4.7~nm\footnote{This corresponds to photon energies from 25~keV to 0.26~keV respectively.}. 
    
There are currently 3 detectors being designed for use at XFEL: Adaptive Gain Integrating Pixel Detector (AGIPD), DEPFET Sensor with Signal Compression (DSSC) and Large Pixel Detector (LPD). All three detectors share a common set of requirements~\cite{xfel_website}:
\begin{description}
    \item[Swiftness] XFEL produces 27,000 X-ray pulses per second, ideally all of these need to be recorded.
    \item[Dynamic range] In any one flash the number of photons received by any portion of the detector can vary massively (between 1 and \(10^5\)~\cite{lpd_manual}) this information needs to be preserved by the detector.
    \item[Radiation resistance] When fully operational XFEL is intended to be used nearly continuously, obviously any detector used has to be able to survive the harsh environment at the end of the beam-line.
\end{description}
Each detector is controlled during operation through the Clock and Control Card (CCC) that provides an interface to the common timing system and basic control. The detectors have to provide their own translation layer that is responsible for creating the interface between the CCC and their own hardware. 

For the Large Pixel Detector the interface is hosted on a dedicated card called the Front End Module (FEM), each FEM controls a single `supermodule', the final LPD will comprise 16 supermodules. Slow control of the FEM (i.e.\ for configuration) is executed via a custom control channel which is separate to the generic CCC.
% section xfel_an_overview (end)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Firmware} % (fold)
\label{sec:firmware}
Firmware refers to programs that are run from persistent memory (rather than being loaded into volatile memory), more generally it tends to operate at the interface between hardware and software. Firmware sacrifices some of the flexibility (in terms of portability and complexity) in order to gain speed by running directly on the hardware. 

There are a variety of languages for writing firmware the one used for LPD is VHSIC Hardware description language (VHDL). VHDL works by describing the expected operation of various discrete blocks within the firmware, these descriptions are then translated (synthesised) into bit-code that the chip can run. Testing is done using simulation of the system as well as on-chip testing.

For the LPD firmware is run on Field Programmable Gate Arrays (FPGA) which combine logic `slices' and on board memory to create flexible and powerful chips. This means that software can be used to control configuration settings for the firmware which then can run with very low latencies and in a highly predictable manner.

% Firmware was run on Field Programmable Gate Arrays (FPGA) which 
% Firmware is the name given for programs that are executed from persistent memory rather than volatile memory, more generally it is what lies between hardware and software. One of the most common forms of programmable hardware are `Field Programmable Gate Arrays' (FPGAs) these are literally chips who's logic can be re-written at any time. 
% TODO FIX ALL OF THIS IT SUCKS
% An FPGA is made from many discrete `slices' each slice comprises a look up table and some amount of logic that means that the FPGA as a whole can be programmed to run a large variety of different programs. This gives an FPGA much greater flexibility over what it can perform compared to custom designed chips (ASICs) as they can have their logic re-written as required, it does also mean that they can generally not be used in such 
% section firmware (end)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Clock and Control Card (CCC)} % (fold)
\label{sec:the_clock_and_control_card_ccc}
With bunches every 220~ns timing has to be carefully controlled across the many systems  that make up XFEL (e.g.\ accelerator, undulators), this is done using a common clock that is distributed via a common interface. To maintain a simple interface for the detectors they all use a common `Clock and Control Card' (CCC) that ensures only information relevant to the detectors is passed to them (e.g. when a train is about to start). 
    
Information is supplied from the CCC over 4 lines: command (cmd), veto, clock and a status line (see table~\ref{tab:ccc_spec}). Of the 4 lines the \texttt{cmd} and \texttt{veto} are most important to us (the \texttt{clk} only contains the clock and the \texttt{status} line is currently intended to return a heartbeat\footnote{i.e.\ the \texttt{clk} in order to confirm operation.}). Between the \texttt{cmd} and \texttt{veto} lines there are 5 commands that concern us and to which responses need to be made: \texttt{START}, \texttt{STOP}, \texttt{RESET}, \texttt{VETO} and \texttt{NO-VETO} (see table~\ref{tab:ccc_commands}).
\begin{table}
    \begin{center}
        \begin{tabular}{c|l}
            Line & Notes \\
            \hline
            clk    & Fast clock derived from the system clock (likely 99.31~MHz).\\
            cmd    & Fast command signals (\texttt{START}, \texttt{STOP} etc.)   \\
            veto   & Veto/no-veto.                                               \\
            status & Return line from the ASIC to the CCC.                       \\
        \end{tabular}
    \end{center}
    \caption{Clock and control card signal specification}
    \label{tab:ccc_spec}
\end{table}
    
\begin{table}
    \begin{center}
        \begin{tabulary}{\textwidth}{c | c | c | C | l}
            Line & Command & Value & Payload & Description \\
            \hline
            \multirow{5}{*}[11.5pt]{Control} 
            & START & 1100 & Train ID (32b), bunch pattern ID (8b), checksum (8b) & Start of the train \\
            & STOP  & 1010 & none                                                 & End of the train \\
            & RESET & 1001 & none                                                 & Reset the FEE and ASIC \\
            \hline
            
            \multirow{2}{*}{Veto} 
            & VETO   & 110 & \multirow{2}{*}{Bunch ID (8b)} & Veto this bunch \\
            & NOVETO & 101 &                                & Record this bunch \\
        \end{tabulary}
    \end{center}
    \caption{Command definitions for the fast and veto lines from the CCC, see \cite{xfel_veto_spec} for more details.}
    \label{tab:ccc_commands}
\end{table}
    
% section the_clock_and_control_card_ccc (end)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Large Pixel Detector (LPD)} % (fold)
\label{sec:the_large_pixel_detector_lpd}
The Large Pixel Detector (LPD) is a 2D, 1~Mega-pixel detector designed at the Rutherford Appleton Laboratory in the UK. The detector is designed to be modular with 1~Megapixel being made up of 16 `supermodules', each supermodule contains 128 Application Specific Integrated Circuits (ASICs) controlled by a single Front End Module (FEM). The ASICs each control and readout 512 pixels (i.e.\ each supermodule has 65,536 pixels).
    
The ASIC used is responsible for readout of the pixels 2 lines are used to control the ASIC during operation: \texttt{clk} and \texttt{cmd}. The clock signal is the same received from the CCC. The command line sends words that communicate the various commands received from the CCC. The set of commands used to control the ASIC are more verbose than those received from the CCC (see chapter~\ref{cha:asic_command_words}). 
    
The FEM that controls the supermodule uses a Xilinx~Virtex-5 FPGA, this uses two embedded PowerPC440 processors. These processors are used to manage the resources on the FEM (e.g.\ writing control registers and the dedicated RAM) as well as create the UDP/IP packets that transfer the data from read from the ASIC to the `train builder'. The control signals from the CCC to the ASIC are processed in dedicated firmware that maintains a constant latency along this pathway. The signals produced by this block are fanned out using 2 further FPGAs (Xilinx~Spartan-3's) that are sent out to the ASICs on the backplane connector.
    
The ASIC uses 20b commands that are synchronised to the bunches in the beam-line. Each word starts with a synchronisation bit then 8b of command the remainder of the word is 0's (other than a re-synchronisation command which uses all 20b). For the CCC-\texttt{cmd} line commands (i.e.\ \texttt{START}, \texttt{STOP} and \texttt{RESET}) the ASIC requires multiple words to enter the require state (e.g.\ for \texttt{START} 6 words need to be sent).
% section the_large_pixel_detector_lpd (end)
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{Firmware, VHDL and FPGAs} % (fold)
% \label{sec:firmware_vhdl_and_fpgas}
% 
% % section firmware_vhdl_and_fpgas (end)
% section introduction (end)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    
    
    
    
% The Large Pixel Detector (LPD) is being built for the European X-ray Free-Electron Laser (Eu-XFEL). To maintain synchronisation between the machine and the detectors a common Clock and Control Card (CCC) is being developed. To communicate with the LPD-ASIC a Front End Electronics card (FEE) has been developed that will act as a fan out for commands and provide detector specific control.
%     
%     In order to control the ASIC via the CCC interface firmware was written to act as a translator unit. Translation was split into three separate sub-blocks: CCC-signal receiver, a veto filter and the ASIC command transmitter. Between the three blocks the messages from the CCC are interpreted, processed and encoded for the ASIC. 
%     
%     Table~\ref{tab:ccc_spec} gives the specification of the CCC interface whilst table~\ref{tab:asic_spec} is the ASIC interface. The CCC specification specifies 5 command words for the cmd and veto lines that the interface needs to interpret: \texttt{START}, \texttt{STOP}, \texttt{RESET}, \texttt{VETO} and \texttt{NO-VETO} (full specification of these are given in table~\ref{tab:ccc_commands}). Each of these command words correspond to either a single word or a sequence that must be sent to the ASIC. \texttt{START}, \texttt{STOP} and \texttt{RESET} all have multi-word sequences associated to them whilst \texttt{VETO} and \texttt{NOVETO} are communicated with single words. The command sequences for the ASIC are specified in the LPD manual~\cite{lpd_manual}, the command words are given in appendix~\ref{cha:asic_command_words}.
%     
% 
%     \begin{table}
%         \begin{center}
%             \begin{tabular}{c|l}
%                 Line       & Notes                                       \\
%                 \hline
%                 CLK        & The system clock, as received from the CCC. \\
%                 SERIAL\_IN & Serial command line.                        \\
%             \end{tabular}
%         \end{center}
%         \caption{ASIC signal specification}
%         \label{tab:asic_spec}
%     \end{table}
%   

%     % section introduction (end)
%     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%